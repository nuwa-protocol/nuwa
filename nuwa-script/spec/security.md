# Nuwa Script Security Model

This document outlines the security considerations, design principles, and best practices related to Nuwa Script.

## Security Goals

Nuwa Script is designed with safety as a primary concern, especially given that scripts might be generated by AI models. The main security goals are:

1.  **Prevent Arbitrary Code Execution:** The script itself should not be able to execute arbitrary code on the host system.
2.  **Controlled Interaction:** All interactions with the external environment (filesystem, network, APIs, etc.) must be mediated through explicitly registered and controlled "Tools".
3.  **Isolation:** The script execution environment should be isolated from the host application's core logic and sensitive data, except where explicitly permitted via Tools.
4.  **Predictability:** The script's behavior should be predictable and constrained by its limited syntax and the capabilities of the registered tools.

## Threat Model

Potential security risks include:

*   **Malicious Script Generation:** An AI model might generate a script intended to abuse available tools (e.g., calling an API excessively, deleting important data via a tool).
*   **Insecure Tool Implementation:** A registered tool might have vulnerabilities (e.g., improper input validation leading to injection attacks *within the tool*, exposing sensitive data).
*   **Information Leakage:** A script might use tools (e.g., `PRINT` or a network tool) to leak sensitive information available in its context or state.
*   **Denial of Service (DoS):** A script might attempt to consume excessive resources (CPU, memory, API quotas) through loops or repeated tool calls.

## Security Mechanisms & Design Principles

Nuwa Script relies on several mechanisms and design choices to mitigate these risks:

1.  **Sandboxed Execution:** The Nuwa Script interpreter itself provides a limited execution environment. The language syntax is simple and lacks features for direct system interaction (no direct file I/O, network sockets, OS command execution, etc.).
2.  **Tool-Centric Architecture:** This is the **cornerstone** of Nuwa Script's security. All external actions *must* be performed by calling registered `ToolFunction`s. The host application has complete control over:
    *   Which tools are registered and available to the script.
    *   The implementation logic of each tool.
3.  **Tool Implementation Responsibility:** The security of actions performed by a tool (e.g., validating inputs, handling errors securely, controlling external API calls) is the responsibility of the **tool developer** (usually the developer integrating the Nuwa Script interpreter into the host application). The interpreter itself does not typically sandbox the *tool's code*; it only manages its invocation.
4.  **Explicit State Management:** State shared between tools is managed explicitly through the `ToolContext` and `ToolRegistry`. Tools should only expose necessary information via state.
5.  **Argument Evaluation:** The interpreter evaluates arguments passed to tools within the script's context *before* passing them to the `ToolFunction`. This ensures the tool receives concrete data types, but the tool implementation must still validate the *content* of these arguments.

## Limitations & Host Application Responsibilities

Nuwa Script's security relies heavily on the host application and tool implementations:

*   **Tool Safety:** The most critical aspect is ensuring that all registered tools are themselves secure and perform appropriate validation and error handling.
*   **Resource Limits:** The core Nuwa Script interpreter may not inherently enforce resource limits (execution time, memory usage, loop iterations, number of tool calls). The **host application** is responsible for implementing such limits if required, potentially by:
    *   Monitoring execution time and interrupting long-running scripts.
    *   Limiting the number of statements or tool calls allowed.
    *   Using underlying platform features (e.g., separate processes, resource quotas).
*   **Permissions/Capabilities:** Nuwa Script itself doesn't have a built-in, fine-grained permission system beyond controlling which tools are registered. If different scripts require different levels of access, the **host application** must manage this, potentially by:
    *   Using different `ToolRegistry` instances with varying sets of tools for different script execution contexts.
    *   Passing specific credentials or permissions through the `ToolContext` for tools to check.

## Best Practices

*   **Minimize Tool Capabilities:** Only register tools that are strictly necessary for the intended use case. Follow the principle of least privilege.
*   **Secure Tool Implementation:**
    *   Thoroughly validate all arguments received in `ToolFunction`s, even though the interpreter provides basic type evaluation. Treat arguments as untrusted input.
    *   Implement robust error handling within tools.
    *   Avoid exposing sensitive internal application details or APIs through tools unless absolutely necessary and properly secured.
    *   Handle secrets (API keys, etc.) securely within the tool implementation, avoiding hardcoding or exposing them to the script state if possible.
*   **Implement Resource Limits:** The host application should enforce limits on script execution time, memory, and tool call frequency to prevent DoS attacks.
*   **Audit and Review:** Regularly review the registered tools and the types of scripts being generated/executed.
*   **Input Sanitization (for Script Generation):** If the script content itself is influenced by external untrusted input *before* being passed to the AI for generation, ensure that input is properly sanitized to prevent prompt injection attacks that could manipulate the AI into generating malicious scripts.
*   **Output Handling:** Be cautious about how the output of scripts (e.g., from `PRINT`) is displayed or used, especially if it might contain sensitive information retrieved by tools.

By combining the constrained nature of the language with careful tool implementation and host application controls, Nuwa Script can provide a relatively safe environment for AI-driven task execution.
