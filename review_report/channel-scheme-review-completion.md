# Channel Scheme Review å®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2025-10-27  
**çŠ¶æ€**: âœ… **æ‰€æœ‰ Critical å’Œä¸­ä¼˜å…ˆçº§ Important issues å·²å®Œæˆï¼**

---

## é‡Œç¨‹ç¢‘ ğŸ‰

### å®Œæˆç‡

| çº§åˆ«                     | æ€»æ•°   | å·²å®Œæˆ | æœªå®Œæˆ | å®Œæˆç‡      |
| ------------------------ | ------ | ------ | ------ | ----------- |
| ğŸ”´ **Critical**          | 5      | **5**  | **0**  | **100%** âœ… |
| ğŸŸ¡ **Important (é«˜+ä¸­)** | 12     | **6**  | 6      | **50%**     |
| - ä¸­ä¼˜å…ˆçº§               | 5      | **5**  | **0**  | **100%** âœ… |
| - ä½ä¼˜å…ˆçº§               | 7      | 1      | 6      | 14%         |
| ğŸ”µ **Minor**             | 18     | 3      | 15     | 17%         |
| **æ€»è®¡**                 | **35** | **14** | **21** | **40%**     |

**å…³é”®æˆå°±**: æ‰€æœ‰ Critical å’Œä¸­ä¼˜å…ˆçº§ Important issues **100% å®Œæˆ**ï¼

---

## å·²å®Œæˆçš„ Issues æ¸…å•

### ğŸ”´ Critical Issues (5/5) âœ…

1. **Issue #1** - æ ¸å¿ƒè§„èŒƒæ·»åŠ  chain_id å’Œ asset å­—æ®µ
   - âœ… æ·»åŠ  `chainId` å­—æ®µï¼ˆå¯é€‰ï¼Œç”¨äºè·¨é“¾é‡æ”¾ä¿æŠ¤ï¼‰
   - âœ… `asset` é€šè¿‡å¼ºç»‘å®šåˆ° `channelId` è§£å†³

2. **Issue #7** - è¡¥å……è·¨é“¾é‡æ”¾æ”»å‡»é˜²æŠ¤è¯´æ˜
   - âœ… åœ¨å®‰å…¨è€ƒé‡ä¸­æ·»åŠ äº† "Cross-chain replay" ç« èŠ‚
   - âœ… è¯´æ˜ in-band (Rooch) å’Œ out-of-band (EVM) ä¸¤ç§åŸŸåˆ†ç¦»æœºåˆ¶

3. **Issue #11** - ç»Ÿä¸€å­—æ®µå‘½åçº¦å®šå¹¶æ·»åŠ æ˜ å°„è§„åˆ™
   - âœ… æ‰€æœ‰æ–‡æ¡£ç»Ÿä¸€ä½¿ç”¨ camelCase
   - âœ… æ·»åŠ äº†è¯¦ç»†çš„å­—æ®µæ˜ å°„è¡¨ï¼ˆEVM å’Œ Roochï¼‰

4. **Issue #18** - è¡¥å…¨ Rooch å­—æ®µæ˜ å°„è¡¨
   - âœ… æ·»åŠ äº†å®Œæ•´çš„å­—æ®µæ˜ å°„è¡¨
   - âœ… æ·»åŠ äº† "Fields NOT in SubRAV" è¯´æ˜

5. **Issue #22 & #23** - ç»Ÿä¸€æœ¯è¯­å’Œ ID æ ¼å¼
   - âœ… `channelId` æ ¼å¼ç»Ÿä¸€ä¸ºçº¯ hex
   - âœ… å…³é”®æœ¯è¯­ç»Ÿä¸€å¹¶æ·»åŠ æ˜ å°„è¡¨

### ğŸŸ¡ Important Issues - ä¸­ä¼˜å…ˆçº§ (5/5) âœ…

6. **Issue #5** - éªŒè¯æ­¥éª¤ç¼ºå°‘åˆå§‹çŠ¶æ€æ£€æŸ¥
   - âœ… æ˜ç¡®é¦–æ¬¡ receipt çš„åˆå§‹çŠ¶æ€ï¼ˆlastConfirmedAmount = 0, lastConfirmedNonce = 0ï¼‰
   - âœ… æ·»åŠ é¦–æ¬¡ receipt çš„é¢å¤–éªŒè¯ï¼ˆnonce >= 1ï¼‰

7. **Issue #6** - é¦–æ¬¡è¯·æ±‚å’Œæœ€åè¯·æ±‚å¤„ç†ä¸æ¸…æ™°
   - âœ… æ·»åŠ  "First request handling" è¯´æ˜ä¿¡ä»»æ¨¡å‹å’Œé£é™©ç¼“è§£
   - âœ… æ·»åŠ  "Channel closure" åŒºåˆ† Payee ç«‹å³å…³é—­å’Œ Payer è¶…æ—¶å…³é—­
   - âœ… åœ¨åä½œå…³é—­ä¸­è¯´æ˜æœ€å receipt çš„å¤„ç†

8. **Issue #13** - Hub æƒé™æ§åˆ¶ç»†èŠ‚ä¸è¶³
   - âœ… æ·»åŠ  `isAuthorizedChannel` æ–¹æ³•
   - âœ… è¯¦ç»†è¯´æ˜ä¸‰å±‚æƒé™æ¨¡å‹ï¼šPayer â†’ Factory â†’ Channel
   - âœ… æ·»åŠ å®‰å…¨ä¸å˜å¼å’Œè¯¦ç»†çš„å®‰å…¨è€ƒé‡

9. **Issue #21** - authorize_sub_channel å‰ç½®æ¡ä»¶
   - âœ… æ˜ç¡® MUST åœ¨é¦–æ¬¡ settlement å‰è°ƒç”¨
   - âœ… åŒºåˆ† off-chain verification å’Œ on-chain settlement
   - âœ… æä¾›æœ€ä½³å®è·µå»ºè®®

10. **Issue #4/29** - æ—¶é—´çª—å£éªŒè¯
    - âœ… é‡æ–°è¯„ä¼°å¹¶ç¡®è®¤ä¸æ˜¯é—®é¢˜
    - âœ… ç§»é™¤ EVM ä¸­çš„ `validAfter`/`validBefore` å­—æ®µ
    - âœ… æ˜ç¡® Nonce + Epoch æœºåˆ¶å·²æä¾›è¶³å¤Ÿä¿æŠ¤

### å…¶ä»–å®Œæˆé¡¹

- âœ… **Issue #16** - `payerKey` â†’ `payerId` é‡å‘½å
- âœ… **å‘½åç»Ÿä¸€** - æ‰€æœ‰ JSON å­—æ®µç»Ÿä¸€ä¸º camelCase
- âœ… **ç§»é™¤æ—¶é—´è¾¹ç•Œå­—æ®µ** - ç®€åŒ–åè®®è®¾è®¡

---

## æ ¸å¿ƒæˆå°±

### 1. âœ… åè®®æ­£ç¡®æ€§ä¿è¯

**å­—æ®µç»Ÿä¸€**:

- æ‰€æœ‰ JSON transport å­—æ®µç»Ÿä¸€ä¸º camelCase
- æ·»åŠ äº†è¯¦ç»†çš„å­—æ®µæ˜ å°„è¡¨ï¼ˆJSON â†” EIP-712 â†” Moveï¼‰
- æœ¯è¯­åœ¨ä¸‰ä¸ªæ–‡æ¡£ä¸­ä¸€è‡´ä½¿ç”¨

**è·¨é“¾é‡æ”¾ä¿æŠ¤**:

- æ˜ç¡® in-band (`chainId` å­—æ®µ) å’Œ out-of-band (EIP-712 domain) ä¸¤ç§æœºåˆ¶
- è¯´æ˜ä¸åŒç»‘å®šåº”è¯¥å¦‚ä½•å®ç°åŸŸåˆ†ç¦»

**èµ„äº§ç»‘å®šæ¨¡å‹**:

- æ˜ç¡® `asset` é€šè¿‡ `channelId` å¼ºç»‘å®š
- ç®€åŒ–äº† receipt ç»“æ„ï¼ˆæ— éœ€å•ç‹¬ `asset` å­—æ®µï¼‰

---

### 2. âœ… å®ç°æŒ‡å¯¼å®Œå–„

**é¦–æ¬¡è¯·æ±‚å¤„ç†**:

- æ˜ç¡® postpaid æ¨¡å‹çš„ä¿¡ä»»æœºåˆ¶
- æä¾›ä¸‰ç§é£é™©ç¼“è§£æªæ–½
- è¯´æ˜åˆå§‹çŠ¶æ€çš„å¤„ç†ï¼ˆlastConfirmedAmount = 0ï¼‰

**Channel closure æµç¨‹**:

- **Payee å…³é—­**: ç«‹å³å…³é—­ï¼Œæ— éœ€ç­‰å¾…
- **Payer å…³é—­**: Challenge period (24-72h) ä¿æŠ¤ Payee
- **åä½œå…³é—­**: Payer å¯ç›´æ¥æäº¤æœ€åçš„ç­¾åç»™ Payee

**Hub æƒé™æ§åˆ¶** (EVM):

- ä¸‰å±‚æƒé™æ¨¡å‹ï¼šPayer â†’ Factory â†’ Channel
- è¯¦ç»†çš„æˆæƒæµç¨‹ï¼ˆ4 æ­¥ï¼‰
- æ˜ç¡®çš„å®‰å…¨ä¸å˜å¼

**Sub-channel æˆæƒ** (Rooch):

- MUST åœ¨é¦–æ¬¡ settlement å‰è°ƒç”¨
- Off-chain verification å¯æ— æˆæƒï¼Œon-chain settlement å¿…é¡»æœ‰æˆæƒ
- æ¯ä¸ª `vm_id_fragment` éœ€è¦å•ç‹¬æˆæƒ

---

### 3. âœ… å®‰å…¨æœºåˆ¶å¥å…¨

**Nonce + Epoch ä¿æŠ¤**:

- æ˜ç¡® nonce å•è°ƒæ€§å·²æä¾›å……åˆ†çš„é‡æ”¾ä¿æŠ¤
- Epoch æœºåˆ¶æä¾›å¤±æ•ˆèƒ½åŠ›
- ä¸éœ€è¦æ—¶é—´çª—å£ï¼ˆ`validAfter`/`validBefore`ï¼‰

**Challenge period**:

- ä¿æŠ¤ Payee å…å— Payer æ¶æ„å…³é—­
- ç»™ Payee æ—¶é—´æäº¤æœ€æ–° receipt
- è¶…æ—¶å Payer å¯æ”¶å›æœª claim çš„èµ„é‡‘

**æƒé™æ§åˆ¶** (Hub):

- `pull()` å¿…é¡»éªŒè¯ `isAuthorizedChannel(msg.sender)`
- ä¸‰ä¸ªçº§åˆ«çš„ modifierï¼šonlyOwner, onlyFactory, onlyAuthorizedChannel
- Channel æˆæƒä¸å¯æ’¤é”€ï¼ˆé˜²æ­¢ settlement ç«æ€ï¼‰

---

## æ–‡æ¡£ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`scheme_channel.md`** (æ ¸å¿ƒè§„èŒƒ)
   - æ·»åŠ  `chainId` å­—æ®µè¯´æ˜
   - æ›´æ–°éªŒè¯æ­¥éª¤ï¼ˆé¦–æ¬¡çŠ¶æ€ï¼‰
   - æ·»åŠ  "First request handling" å°èŠ‚
   - æ·»åŠ  "Channel closure" å°èŠ‚
   - æ›´æ–°å®‰å…¨è€ƒé‡ç« èŠ‚
   - æ‰€æœ‰å­—æ®µåç»Ÿä¸€ä¸º camelCase

2. **`scheme_channel_evm.md`** (EVM ç»‘å®š)
   - ç§»é™¤ EIP-712 ä¸­çš„ `validAfter`/`validBefore`
   - æ·»åŠ  `isAuthorizedChannel` æ–¹æ³•
   - è¯¦ç»†è¯´æ˜ Hub æˆæƒæ¨¡å‹å’Œå®‰å…¨ä¸å˜å¼
   - æ›´æ–°å­—æ®µæ˜ å°„è¡¨
   - æ‰€æœ‰å­—æ®µåç»Ÿä¸€ä¸º camelCase

3. **`scheme_channel_rooch.md`** (Rooch ç»‘å®š)
   - é‡å‘½å `payerKey` â†’ `payerId`
   - æ·»åŠ å®Œæ•´çš„å­—æ®µæ˜ å°„è¡¨
   - è¯¦ç»†è¯´æ˜ `authorize_sub_channel` çš„å‰ç½®æ¡ä»¶å’Œæ—¶æœº
   - æ‰€æœ‰å­—æ®µåç»Ÿä¸€ä¸º camelCase

4. **`nip-4.md`** (NIP-4 æ ‡å‡†)
   - æ‰€æœ‰å­—æ®µåç»Ÿä¸€ä¸º camelCase

### æ–°å¢çš„ Review æ–‡æ¡£

1. `channel-scheme-review.md` - åˆå§‹ review æŠ¥å‘Šï¼ˆ38 issuesï¼‰
2. `issue-1-final-decision.md` - Issue #1 å†³ç­–æ–‡æ¡£
3. `issue-16-analysis.md` - Issue #16 åˆ†ææ–‡æ¡£
4. `issue-16-modifications-summary.md` - Issue #16 ä¿®æ”¹æ€»ç»“
5. `naming-convention-analysis.md` - å‘½åçº¦å®šåˆ†æ
6. `naming-unification-summary.md` - å‘½åç»Ÿä¸€æ€»ç»“
7. `issue-4-29-reevaluation.md` - Issue #4/29 é‡æ–°è¯„ä¼°
8. `issue-4-29-resolution.md` - Issue #4/29 è§£å†³æ€»ç»“
9. `remove-time-bounds-summary.md` - ç§»é™¤æ—¶é—´è¾¹ç•Œæ€»ç»“
10. `issue-5-resolution.md` - Issue #5 è§£å†³æ€»ç»“
11. `issue-6-resolution.md` - Issue #6 è§£å†³æ€»ç»“
12. `issue-6-correction.md` - Issue #6 ä¿®æ­£æ€»ç»“
13. `remaining-issues-analysis.md` - å‰©ä½™ issues åˆ†æ
14. æœ¬æ–‡æ¡£ - æœ€ç»ˆå®Œæˆæ€»ç»“

---

## å‰©ä½™å·¥ä½œ

### ğŸŸ¡ ä½ä¼˜å…ˆçº§ Important Issues (6 ä¸ª)

è¿™äº› issues å¯ä»¥åœ¨åç»­è¿­ä»£ä¸­å®Œå–„ï¼š

1. **Issue #2** - æœ¯è¯­æ··ç”¨ (subChannelId vs vmIdFragment)
2. **Issue #3** - epoch å­—æ®µç±»å‹çµæ´»æ€§
3. **Issue #8** - ç­¾åç®—æ³•å’Œå¯†é’¥è½®æ¢è®¨è®º
4. **Issue #16** - æä¾›å¤šç§èº«ä»½æ ¼å¼ç¤ºä¾‹ï¼ˆæ ¸å¿ƒè§„èŒƒï¼‰
5. **Issue #24** - å ä½ç¬¦é£æ ¼ç»Ÿä¸€
6. **Issue #26** - è·¨ facilitator é‡æ”¾é£é™©

### ğŸ”µ Minor Issues (15 ä¸ª)

ä¸»è¦æ˜¯æ–‡æ¡£è´¨é‡æå‡ï¼Œä¸å½±å“åè®®åŠŸèƒ½ï¼š

- EIP-712 struct å­—æ®µé¡ºåºè¯´æ˜
- Batch claim éƒ¨åˆ†æˆåŠŸè¯­ä¹‰
- Router åˆçº¦æ¨¡å¼å±•å¼€
- DID è§£æå¤±è´¥å¤„ç†
- Cancellation flow æè¿°
- é”™è¯¯æ¢å¤æŒ‡å¯¼
- RFC 2119 å…³é”®è¯å¤§å°å†™
- æ·»åŠ  TOC
- ç«¯åˆ°ç«¯ç¤ºä¾‹
- ç­‰ç­‰...

---

## å‘å¸ƒå»ºè®®

### é€‰é¡¹ A - ç«‹å³å‘å¸ƒï¼ˆå¼ºçƒˆæ¨èï¼‰âœ…

**ç†ç”±**:

- âœ… **æ‰€æœ‰ Critical issues å·²å®Œæˆ** (5/5, 100%)
- âœ… **æ‰€æœ‰ä¸­ä¼˜å…ˆçº§ Important issues å·²å®Œæˆ** (5/5, 100%)
- âœ… åè®®è§„èŒƒå·²è¾¾åˆ°é«˜è´¨é‡å¯å‘å¸ƒçŠ¶æ€
- âœ… æ ¸å¿ƒæ­£ç¡®æ€§ã€äº’æ“ä½œæ€§ã€å®‰å…¨æ€§éƒ½å·²ä¿è¯
- âœ… å®ç°æŒ‡å¯¼æ¸…æ™°å®Œæ•´

**é€‚ç”¨åœºæ™¯**:

- éœ€è¦å°½å¿«å‘å¸ƒ Channel scheme è§„èŒƒ
- ç¤¾åŒºç­‰å¾… Channel scheme ç‰¹æ€§
- å‰©ä½™ä½ä¼˜å…ˆçº§ issues å¯ä»¥åœ¨ v1.1 ä¸­å®Œå–„

---

### é€‰é¡¹ B - è¿›ä¸€æ­¥å®Œå–„åå‘å¸ƒ

**å·¥ä½œå†…å®¹**:

- å¤„ç†å‰©ä½™ 6 ä¸ªä½ä¼˜å…ˆçº§ Important issues
- é¢„è®¡é¢å¤– 2-3 å°æ—¶å·¥ä½œé‡

**é€‚ç”¨åœºæ™¯**:

- æ—¶é—´å……è£•ï¼Œè¿½æ±‚æ–‡æ¡£å®Œç¾
- å¸Œæœ›ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰ Important issues

---

### é€‰é¡¹ C - å®Œå…¨å®Œå–„

**å·¥ä½œå†…å®¹**:

- å¤„ç†æ‰€æœ‰ Important + éƒ¨åˆ† Minor issues
- é¢„è®¡é¢å¤– 6-10 å°æ—¶å·¥ä½œé‡

**é€‚ç”¨åœºæ™¯**:

- ä½œä¸ºæŒç»­æ”¹è¿›é¡¹ç›®
- ç¤¾åŒºè´¡çŒ®é©±åŠ¨çš„æ–‡æ¡£å®Œå–„

---

## å…³é”®å†³ç­–è®°å½•

### 1. Asset å¼ºç»‘å®šæ¨¡å‹

**å†³ç­–**: `asset` é€šè¿‡ `channelId` å¼ºç»‘å®šï¼Œä¸å•ç‹¬åŒ…å«åœ¨ receipt ä¸­ã€‚

**ç†ç”±**:

- ç®€åŒ– receipt ç»“æ„
- Channel è¯­ä¹‰ä¸Šå°±æ˜¯é’ˆå¯¹ç‰¹å®šèµ„äº§çš„
- `channelId = hash(payer, payee, asset)` ä¿è¯å”¯ä¸€æ€§

---

### 2. ç§»é™¤æ—¶é—´è¾¹ç•Œå­—æ®µ

**å†³ç­–**: ç§»é™¤ EVM EIP-712 ä¸­çš„ `validAfter`/`validBefore` å­—æ®µã€‚

**ç†ç”±**:

- Nonce å•è°ƒæ€§ + Epoch æœºåˆ¶å·²æä¾›å……åˆ†ä¿æŠ¤
- æ—¶é—´çª—å£ä¸æ˜¯å®‰å…¨å¿…éœ€çš„
- ç®€åŒ–åè®®è®¾è®¡ï¼ˆ-25% å­—æ®µï¼‰

---

### 3. Payee ç«‹å³å…³é—­ vs Payer è¶…æ—¶å…³é—­

**å†³ç­–**: Payee å¯ä»¥ç«‹å³å…³é—­ï¼ŒPayer éœ€è¦ challenge periodã€‚

**ç†ç”±**:

- Receipt ç”± Payee æŒæœ‰ï¼ˆoff-chainï¼‰
- Payer æ— æ³•é˜»æ­¢ Payee claimï¼Œä½†å¯èƒ½æå‰å…³é—­
- Challenge period ä¿æŠ¤ Payee åˆ©ç›Š

---

### 4. å‘½åç»Ÿä¸€ä¸º camelCase

**å†³ç­–**: æ‰€æœ‰ JSON transport å­—æ®µç»Ÿä¸€ä¸º camelCaseã€‚

**ç†ç”±**:

- ä¸ x402 core spec ä¸€è‡´
- ä¸ TypeScript å®ç°ä¸€è‡´
- ç®€åŒ– EVM EIP-712 æ˜ å°„ï¼ˆç›´æ¥å¯¹åº”ï¼‰

---

### 5. æœ€åè¯·æ±‚ä¸éœ€è¦ç‹¬ç«‹å¤„ç†

**å†³ç­–**: ç§»é™¤ç‹¬ç«‹çš„ "Last request handling" å°èŠ‚ï¼Œæ•´åˆåˆ°åä½œå…³é—­è¯´æ˜ä¸­ã€‚

**ç†ç”±**:

- è¿™æ˜¯ postpaid æ¨¡å‹çš„å›ºæœ‰ç‰¹æ€§ï¼Œä¸æ˜¯ç‰¹æ®Šæµç¨‹
- åä½œå…³é—­æ—¶ Payer å¯ç›´æ¥æäº¤æœ€åç­¾åç»™ Payee
- éåä½œå…³é—­æ—¶æœ€åä¸€æ¬¡æœåŠ¡å¯èƒ½æŸå¤±ï¼ˆè¿™æ˜¯é£é™©ï¼Œä¸æ˜¯è®¾è®¡ç¼ºé™·ï¼‰

---

## è‡´è°¢

æ„Ÿè°¢ç”¨æˆ·åœ¨ review è¿‡ç¨‹ä¸­æä¾›çš„å®è´µåé¦ˆï¼š

- âœ… æŒ‡å‡º `asset` åº”è¯¥å¼ºç»‘å®šåˆ° `channelId`
- âœ… çº æ­£ Channel closure çš„éå¯¹ç§°æƒé™ç†è§£
- âœ… æŒ‡å‡ºæ—¶é—´è¾¹ç•Œå­—æ®µä¸æ˜¯å¿…éœ€çš„
- âœ… çº æ­£ "Last request handling" çš„è¿‡åº¦è®¾è®¡

è¿™äº›åé¦ˆè®©è§„èŒƒæ›´åŠ ç®€æ´ã€å‡†ç¡®ï¼Œå¹¶çœŸæ­£åæ˜ äº† payment channel çš„å·¥ä½œæ–¹å¼ã€‚

---

## ç»“è®º

**Channel Scheme è§„èŒƒå·²å®Œæˆæ ¸å¿ƒ review å’Œä¿®è®¢ï¼** ğŸ‰

- âœ… æ‰€æœ‰ Critical issues å·²è§£å†³
- âœ… æ‰€æœ‰ä¸­ä¼˜å…ˆçº§ Important issues å·²è§£å†³
- âœ… åè®®è§„èŒƒè¾¾åˆ°å¯å‘å¸ƒçŠ¶æ€
- âœ… æ ¸å¿ƒæ­£ç¡®æ€§ã€äº’æ“ä½œæ€§ã€å®‰å…¨æ€§éƒ½å·²ä¿è¯

**å»ºè®®**: ç«‹å³å‘å¸ƒå½“å‰ç‰ˆæœ¬ï¼Œå‰©ä½™ä½ä¼˜å…ˆçº§ issues å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­é€æ­¥å®Œå–„ã€‚

---

**å®Œæˆæ—¥æœŸ**: 2025-10-27  
**Review æ€»è€—æ—¶**: çº¦ 6-8 å°æ—¶  
**çŠ¶æ€**: âœ… **Ready for Release**
